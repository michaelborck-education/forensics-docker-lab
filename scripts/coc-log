#!/bin/bash

#################################################################################
# Chain of Custody Command Logger
#
# This script logs forensic analysis commands with timestamps, outputs, and hashes
# for comprehensive chain of custody documentation.
#
# Usage: coc-log "command" "note"
# Example: coc-log "fls -r /evidence/usb.img" "Initial filesystem listing"
#
# Creates/updates: cases/Lab_X/analysis_log.csv
#################################################################################

set -euo pipefail

# Get current lab from working directory or environment
LAB_NUM="${1:-}"
COMMAND="${2:-}"
NOTE="${3:-}"

# If called with positional args, use them directly
if [ $# -eq 2 ] && [[ "$1" != "-"* ]]; then
    # coc-log "command" "note" format
    COMMAND="$1"
    NOTE="$2"
    # Try to detect lab from current directory
    if [[ $(pwd) =~ /Lab_([0-9])(/|$) ]]; then
        LAB_NUM="${BASH_REMATCH[1]}"
    fi
fi

# Validate inputs
if [ -z "$COMMAND" ]; then
    echo "Usage: coc-log \"command\" \"note\""
    echo "Example: coc-log \"fls -r /evidence/usb.img\" \"Initial filesystem listing\""
    exit 1
fi

# Determine lab number from current directory if not provided
if [ -z "$LAB_NUM" ] || ! [[ "$LAB_NUM" =~ ^[0-9]$ ]]; then
    if [[ $(pwd) =~ /Lab_([0-9])(/|$) ]]; then
        LAB_NUM="${BASH_REMATCH[1]}"
    else
        # Try to find any Lab_* in path
        LAB_NUM=$(pwd | grep -oP 'Lab_\K[0-9]' | head -1)
        if [ -z "$LAB_NUM" ]; then
            echo "Error: Could not determine lab number. Please run from Lab_X directory."
            echo "Or set: export CURRENT_LAB=1"
            exit 1
        fi
    fi
fi

# Initialize paths
LOG_FILE="/cases/Lab_${LAB_NUM}/analysis_log.csv"
TEMP_OUTPUT="/tmp/coc_output_$$.txt"

# Create log directory if needed
mkdir -p "$(dirname "$LOG_FILE")"

# Get current timestamp in UTC ISO format
TIMESTAMP=$(date -u +'%Y-%m-%dT%H:%M:%SZ')

# Get analyst name from environment or container user
ANALYST="${ANALYST_NAME:-${USER:-analyst}}"

# Execute command and capture output
echo "[*] Executing: $COMMAND" >&2
if eval "$COMMAND" > "$TEMP_OUTPUT" 2>&1; then
    EXIT_CODE="0"
else
    EXIT_CODE="$?"
fi

# Calculate hash of output
OUTPUT_HASH=$(sha256sum "$TEMP_OUTPUT" | cut -d' ' -f1)

# Calculate output file size
OUTPUT_SIZE=$(wc -c < "$TEMP_OUTPUT")

# Create CSV header if file doesn't exist
if [ ! -f "$LOG_FILE" ]; then
    echo "timestamp_utc,analyst,command,exit_code,output_lines,output_hash,note" > "$LOG_FILE"
fi

# Count output lines
OUTPUT_LINES=$(wc -l < "$TEMP_OUTPUT")

# Escape CSV fields (handle quotes and commas)
COMMAND_ESCAPED=$(echo "$COMMAND" | sed 's/"/""/g' | sed 's/,/\,/g')
NOTE_ESCAPED=$(echo "$NOTE" | sed 's/"/""/g' | sed 's/,/\,/g')

# Append entry to log
{
    echo "$TIMESTAMP,$ANALYST,\"$COMMAND_ESCAPED\",$EXIT_CODE,$OUTPUT_LINES,$OUTPUT_HASH,\"$NOTE_ESCAPED\""
} >> "$LOG_FILE"

# Save output to evidence file
OUTPUT_FILE="/cases/Lab_${LAB_NUM}/outputs/$(basename "$COMMAND" | cut -d' ' -f1)_${TIMESTAMP%T*}_${TIMESTAMP##*T}.txt"
mkdir -p "$(dirname "$OUTPUT_FILE")"
cp "$TEMP_OUTPUT" "$OUTPUT_FILE"

# Report
echo "[✓] Command logged to: $LOG_FILE" >&2
if [ "$EXIT_CODE" != "0" ]; then
    echo "[!] Exit code: $EXIT_CODE" >&2
fi
echo "[✓] Output saved to: $OUTPUT_FILE" >&2
echo "[✓] Output hash: $OUTPUT_HASH" >&2

# Display output
cat "$TEMP_OUTPUT"

# Cleanup
rm -f "$TEMP_OUTPUT"

exit $((EXIT_CODE))
